name: Capstone
on: [push]
jobs:
  dependencies:
    runs-on:  ubuntu-latest
    steps:
      - name: install cmake
        run:  sudo apt install cmake

  runs:
    needs:    dependencies
    runs-on:  ubuntu-latest
    steps:
      - name: remove g++-9
        run:  sudo apt remove g++-9
      - name: install g++-10
        run:  sudo apt install g++-10
      - name: configure g++ 10 as default
        run:  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100 --slave /usr/bin/g++ g++ /usr/bin/g++-10 --slave /usr/bin/gcov gcov /usr/bin/gcov-10
      - name: install SDL2
        run:  sudo apt install libsdl2-dev
      - name: install Cap'n Proto
        run:  curl -O https://capnproto.org/capnproto-c++-0.9.1.tar.gz; tar zxf capnproto-c++-0.9.1.tar.gz; cd capnproto-c++-0.9.1; ./configure; make -j6 check; sudo make install
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: configure box2d cmake
        run:  cmake -Hbox2d -Bbox2d/build
      - name: install box2d
        run:  sudo cmake --build box2d/build --target install
      - name: explicitly generate capnp files
        run:  cd lib/Server/; ./gen_proto
      - name: configure cmake
        run:  cmake -H. -Bbuild
      - name: compile the project
        run:  cmake --build build --target Capstone
#      - name: Run the benchmarks
#        run: ./build/Capstone

#  tests:
#    needs: dependencies
#    runs-on:  ubuntu-latest
#    steps:
#      - name: remove g++-9
#        run:  sudo apt remove g++-9
#      - name: install g++-10
#        run:  sudo apt install g++-10
#      - name: configure g++ 10 as default
#        run:  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100 --slave /usr/bin/g++ g++ /usr/bin/g++-10 --slave /usr/bin/gcov gcov /usr/bin/gcov-10
#      - name: install SDL2
#        run:  sudo apt install libsdl2-dev
#      - name: install Cap'n Proto
#        run:  curl -O https://capnproto.org/capnproto-c++-0.9.1.tar.gz; tar zxf capnproto-c++-0.9.1.tar.gz; cd capnproto-c++-0.9.1; ./configure; make -j6 check; sudo make install
#      - uses: actions/checkout@v2
#        with:
#          submodules: recursive
#      - name: configure catch2 cmake
#        run:  cmake -HCatch2 -BCatch2/build -DBUILD_TESTING=OFF
#      - name: build and install catch2
#        run:  sudo cmake --build Catch2/build --target install
#      - name: configure box2d cmake
#        run:  cmake -Hbox2d -Bbox2d/build
#      - name: build and install box2d
#        run:  sudo cmake --build box2d/build --target install
#      - name: explicitly generate capnp files
#        run:  cd lib/Server/; ./gen_proto
#      - name: configure own cmake
#        run:  cmake -H. -Bbuild
#      - name: Build test files
#        run:  cmake --build build --target Test
#      - name: Run the tests
#        run: ./build/Test
